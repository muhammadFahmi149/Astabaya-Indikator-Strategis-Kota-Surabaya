{% extends 'dashboard/dashboard.html' %} 
{% load static %}
{% block dashboard_content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="container py-4">
  <h3 class="font-weight-bold mb-4">IPM - Usia Harapan Hidup saat Lahir (UHH SP)</h3>
  
  <!-- Summary Cards -->
  <div class="row mb-4" style="display: flex; flex-wrap: nowrap; gap: 15px; margin-left: 0; margin-right: 0;">
    <!-- Surabaya Summary Card -->
    <div class="col-6 mb-3" style="flex: 1; min-width: 0; padding-left: 0; padding-right: 0;">
      <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 12px; padding: 25px; min-height: 200px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
        <div style="position: relative; z-index: 2;">
          <h5 style="color: rgba(255, 255, 255, 0.95); font-size: 16px; font-weight: 600; margin: 0 0 15px 0;">
            <i class="fas fa-heartbeat me-2"></i>Kota Surabaya
          </h5>
          <h2 style="font-size: 42px; font-weight: 700; line-height: 1.2; margin: 0 0 10px 0;">
            {% if latest_data and latest_data.value %}
              {{ latest_data.value|floatformat:2 }} tahun
            {% else %}
              -
            {% endif %}
          </h2>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <small style="color: rgba(255, 255, 255, 0.8); font-size: 11px;">
                {% if latest_data %}
                  Tahun {{ latest_data.year }}
                {% else %}
                  Data tidak tersedia
                {% endif %}
              </small>
              {% if change is not None %}
                <div style="display: flex; align-items: center; gap: 5px;">
                  {% if change > 0 %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">▲</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">+{{ change|floatformat:2 }} tahun</span>
                  {% elif change < 0 %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">▼</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">{{ change|floatformat:2 }} tahun</span>
                  {% else %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">-</span>
                  {% endif %}
                  {% if previous_data %} 
                    <span style="color: rgba(255, 255, 255, 0.7); font-size: 10px;">dari {{ previous_data.year }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div style="position: absolute; top: 10px; right: 10px; opacity: 0.1; z-index: 1;">
          <i class="fas fa-heartbeat" style="font-size: 80px;"></i>
        </div>
      </div>
    </div>

    <!-- Jawa Timur Summary Card -->
    <div class="col-6 mb-3" style="flex: 1; min-width: 0; padding-left: 0; padding-right: 0;">
      <div class="summary-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 12px; padding: 25px; min-height: 200px; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);">
        <div style="position: relative; z-index: 2;">
          <h5 style="color: rgba(255, 255, 255, 0.95); font-size: 16px; font-weight: 600; margin: 0 0 15px 0;">
            <i class="fas fa-heartbeat me-2"></i>Jawa Timur
          </h5>
          <h2 style="font-size: 42px; font-weight: 700; line-height: 1.2; margin: 0 0 10px 0;">
            {% if latest_jatim and latest_jatim.value %}
              {{ latest_jatim.value|floatformat:2 }} tahun
            {% else %}
              -
            {% endif %}
          </h2>
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <small style="color: rgba(255, 255, 255, 0.8); font-size: 11px;">
                {% if latest_jatim %}
                  Tahun {{ latest_jatim.year }}
                {% else %}
                  Data tidak tersedia
                {% endif %}
              </small>
              {% if jatim_change is not None %}
                <div style="display: flex; align-items: center; gap: 5px;">
                  {% if jatim_change > 0 %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">▲</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">+{{ jatim_change|floatformat:2 }} tahun</span>
                  {% elif jatim_change < 0 %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">▼</span>
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">{{ jatim_change|floatformat:2 }} tahun</span>
                  {% else %}
                    <span style="color: rgba(255, 255, 255, 0.9); font-size: 12px;">-</span>
                  {% endif %}
                  {% if previous_jatim %} 
                    <span style="color: rgba(255, 255, 255, 0.7); font-size: 10px;">dari {{ previous_jatim.year }}</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div style="position: absolute; top: 10px; right: 10px; opacity: 0.1; z-index: 1;">
          <i class="fas fa-heartbeat" style="font-size: 80px;"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Comparison Chart - 1 chart per row -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="dashboard-card" style="position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h5 class="mb-0">Perbandingan UHH SP: Surabaya vs Jawa Timur</h5>
          <div style="display: flex; gap: 8px;">
            <button id="downloadChartUHHSP" class="btn btn-sm btn-outline-primary" style="padding: 5px 10px; border-radius: 5px;" title="Download Data Excel">
              <i class="fas fa-file-excel"></i> <span>Excel</span>
            </button>
            <button id="downloadImageUHHSP" class="btn btn-sm btn-outline-success" style="padding: 5px 10px; border-radius: 5px;" title="Download Grafik PNG">
              <i class="fas fa-image"></i> <span>PNG</span>
            </button>
          </div>
        </div>
        <div id="comparisonChart" style="width: 100%; height: 450px;"></div>
      </div>
    </div>
  </div>
</div>

<style>
  .dashboard-card {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
  }
  
  .summary-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  }

  /* Responsive styles for summary cards */
  @media (max-width: 768px) {
    .summary-card {
      padding: 15px !important;
      min-height: 150px !important;
    }
    
    .summary-card h5 {
      font-size: 12px !important;
      margin: 0 0 8px 0 !important;
    }
    
    .summary-card h2 {
      font-size: 24px !important;
      margin: 0 0 8px 0 !important;
    }
    
    .summary-card small {
      font-size: 9px !important;
    }
    
    .summary-card span {
      font-size: 10px !important;
    }
    
    .summary-card i[style*="font-size: 80px"] {
      font-size: 50px !important;
    }
    
    /* Download button responsive */
    #downloadChartUHHSP, #downloadImageUHHSP {
      padding: 3px 8px !important;
      font-size: 11px !important;
    }
    
    #downloadChartUHHSP i, #downloadImageUHHSP i {
      font-size: 10px !important;
    }
    
    #downloadChartUHHSP span, #downloadImageUHHSP span {
      display: none;
    }
  }
  
  @media (max-width: 576px) {
    #downloadChartUHHSP, #downloadImageUHHSP {
      padding: 4px 6px !important;
      font-size: 10px !important;
    }
    
    #downloadChartUHHSP i, #downloadImageUHHSP i {
      font-size: 12px !important;
      margin: 0 !important;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Prepare data from Django template
    const surabayaData = [
      {% for data in data_list %}
      {
        year: {{ data.year }},
        value: {{ data.value|default:"null" }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    const jatimData = [
      {% for data in jatim_data %}
      {
        year: {{ data.year }},
        value: {{ data.value|default:"null" }}
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    // Sort data by year
    surabayaData.sort((a, b) => a.year - b.year);
    jatimData.sort((a, b) => a.year - b.year);

    // Get all unique years
    const allYearsSet = new Set([...surabayaData.map(d => d.year), ...jatimData.map(d => d.year)]);
    const allYears = Array.from(allYearsSet).sort((a, b) => a - b);
    
    // Only show last 10 years if more than 10 years
    const displayYears = allYears.length > 10 ? allYears.slice(-10) : allYears;
    const years = displayYears.map(y => y.toString());
    
    // Store displayYears in global scope for export function
    window.displayYearsUHHSP = displayYears;

    // Get values for each year
    const surabayaValues = displayYears.map(year => {
      const data = surabayaData.find(d => d.year === year);
      return data && data.value !== null ? data.value : null;
    });

    const jatimValues = displayYears.map(year => {
      const data = jatimData.find(d => d.year === year);
      return data && data.value !== null ? data.value : null;
    });
    
    // Store values in global scope for export function
    window.surabayaValuesUHHSP = surabayaValues;
    window.jatimValuesUHHSP = jatimValues;
    
    // Store values in global scope for export function
    window.surabayaValuesUHHSP = surabayaValues;
    window.jatimValuesUHHSP = jatimValues;

    // Comparison Chart
    const comparisonChartDom = document.getElementById('comparisonChart');
    const comparisonChart = echarts.init(comparisonChartDom);
    
    comparisonChart.setOption({
      tooltip: {
        trigger: 'axis',
        axisPointer: { 
          type: 'line',
          snap: true,
          lineStyle: {
            type: 'dashed'
          }
        },
        formatter: function(params) {
          let result = 'Tahun: ' + params[0].axisValue + '<br/>';
          params.forEach(function(item) {
            result += item.marker + item.seriesName + ': ' + 
              (item.value !== null ? item.value.toFixed(2) + ' tahun' : 'Data tidak tersedia') + '<br/>';
          });
          return result;
        }
      },
      legend: {
        data: ['Kota Surabaya', 'Jawa Timur'],
        top: 10
      },
      grid: {
        left: '12%',
        right: '4%',
        bottom: '10%',
        top: '20%',
        containLabel: false
      },
      xAxis: {
        type: 'category',
        data: years,
        boundaryGap: false
      },
      yAxis: {
        type: 'value',
        name: 'Usia (tahun)',
        position: 'left',
        nameLocation: 'end',
        nameGap: 10,
        axisLabel: {
          formatter: '{value}'
        }
      },
      series: [
        {
          name: 'Kota Surabaya',
          type: 'line',
          data: surabayaValues,
          itemStyle: { color: 'rgb(245, 158, 11)' },
          lineStyle: { width: 3 },
          symbol: 'circle',
          symbolSize: 8,
          smooth: true,
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [
                { offset: 0, color: 'rgba(245, 158, 11, 0.3)' },
                { offset: 1, color: 'rgba(245, 158, 11, 0.05)' }
              ]
            }
          }
        },
        {
          name: 'Jawa Timur',
          type: 'line',
          data: jatimValues,
          itemStyle: { color: 'rgb(239, 68, 68)' },
          lineStyle: { width: 3 },
          symbol: 'circle',
          symbolSize: 8,
          smooth: true,
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [
                { offset: 0, color: 'rgba(239, 68, 68, 0.3)' },
                { offset: 1, color: 'rgba(239, 68, 68, 0.05)' }
              ]
            }
          }
        }
      ]
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      comparisonChart.resize();
    });

    // Export to Excel function
    function exportToExcelUHHSP() {
      const exportData = [];
      exportData.push(['Tahun', 'Kota Surabaya (tahun)', 'Jawa Timur (tahun)']);
      
      window.displayYearsUHHSP.forEach((year, index) => {
        const surabayaVal = window.surabayaValuesUHHSP[index] !== null ? window.surabayaValuesUHHSP[index].toFixed(2) : 'Data tidak tersedia';
        const jatimVal = window.jatimValuesUHHSP[index] !== null ? window.jatimValuesUHHSP[index].toFixed(2) : 'Data tidak tersedia';
        exportData.push([year.toString(), surabayaVal, jatimVal]);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(exportData);
      ws['!cols'] = [{ wch: 10 }, { wch: 25 }, { wch: 25 }];
      XLSX.utils.book_append_sheet(wb, ws, 'Data UHH SP');
      
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      XLSX.writeFile(wb, `UHH_SP_Surabaya_vs_JawaTimur_${dateStr}.xlsx`);
    }
    
    // Helper function to check authentication before download
    function checkAuthBeforeDownload(callback, itemName = 'data') {
      {% if not user.is_authenticated %}
      // User not authenticated, show login modal
      if (typeof showLoginRequiredModal === 'function') {
        showLoginRequiredModal(itemName);
      } else {
        alert('Ingin mengunduh ' + itemName + ' ini? Silakan login terlebih dahulu.');
        const loginModal = document.getElementById('loginModal');
        if (loginModal) {
          const modal = new bootstrap.Modal(loginModal);
          modal.show();
        } else {
          window.location.href = '{% url "login" %}';
        }
      }
      return false;
      {% else %}
      // User authenticated, proceed with download
      callback();
      return true;
      {% endif %}
    }

    document.getElementById('downloadChartUHHSP').addEventListener('click', function() {
      checkAuthBeforeDownload(exportToExcelUHHSP, 'data UHH SP');
    });
    
    function exportToPNGUHHSP() {
      const url = comparisonChart.getDataURL({
        type: 'png',
        pixelRatio: 2,
        backgroundColor: '#fff'
      });
      const link = document.createElement('a');
      link.download = `UHH_SP_Chart_Surabaya_vs_JawaTimur_${new Date().toISOString().split('T')[0]}.png`;
      link.href = url;
      link.click();
    }
    
    document.getElementById('downloadImageUHHSP').addEventListener('click', function() {
      checkAuthBeforeDownload(exportToPNGUHHSP, 'grafik UHH SP');
    });
  });
</script>

{% endblock %}
